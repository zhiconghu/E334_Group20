---
title: "Group Assignment"
author: "Zhicong Hu"
date: "12/03/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r loadlibraries, include=FALSE, message=FALSE, warning=FALSE}
library(tidyquant)
library(tidyverse)
library(dplyr)
library(ggplot2)

library(tseries) 
library(data.table)
library(vars) # vec2var
library(urca)  # ca.jo, ur.df, finland
library(tsDyn) # VECM
```

# Get data

```{r}
energy_stocks <- c("APA","BKR","COP","CTRA","CVX","DVN","EOG","FANG","HAL","HES","KMI","MPC","MRO","OKE","OXY","PSX","PXD","SLB",
                   "VLO","WMB","XOM")

data <- tq_get(energy_stocks, get = "stock.prices", from = "2018-01-01", to = "2022-01-01") %>% 
  dplyr::select(symbol, date, close) %>% 
  mutate(close = round(close, 2))
```

# Visualization

```{r}
ggplot(data, aes(x = date, y = close, color = symbol)) +
  geom_line() +
  theme_minimal() +
  theme(legend.position = "none")
```

# Data Formatting

```{r}
data <- data %>% 
  pivot_wider(names_from = symbol, values_from = close)
```

# Modelling

We first select two stocks for comparison. They are XOM and CVX.

```{r}
data <- data %>% 
  dplyr::select(date, CVX, XOM) %>% 
  mutate(spread = XOM-CVX)
```

## Test for stationary

Individual

```{r}
adf.test(data$CVX)

adf.test(data$XOM)
```

Spread

```{r}
adf.test(data$CVX-data$XOM)

ggplot(data, aes(x = date, y = spread)) +
  geom_line() +
  theme_minimal() +
  theme(legend.position = "none")
```

## VAR

###Individual

select lag length p
```{r}

df <- data %>% dplyr::select(CVX, XOM)

VARselect(df, lag.max = 5, type = "const")
```
Therefore, we select lag length p=4 for VAR.  

run VAR model
```{r}
var.model <- VAR(df, p = 4, type = "const")

#model output
var.model
```

forecast using VAR

```{r}
# forecasting horizon
nhor <- 12 

var.pred <- predict(var.model, n.ahead = nhor)
x11(); par(mai=rep(0.4, 4)); plot(var.pred)
x11(); par(mai=rep(0.4, 4)); fanchart(var.pred)
```


### Spread

VAR model in difference using vars
```{r}
# 1st differenced data
df.diff <- diff(as.matrix(df), lag = 1)
m.diff <- as.matrix(df.diff)
 
# lag length
VARselect(df.diff, lag.max = 4,
          type = "const")

# estimation
vare_diff <- VAR(df.diff, p = 4, 
                 type = "const")
 
# forecast of differenced data
varf_diff <- predict(vare_diff, n.ahead = nhor)
x11(); par(mai=rep(0.4,4)); plot(varf_diff)
x11(); par(mai=rep(0.4,4)); fanchart(varf_diff)
 
# recover lev forecast
m.lev  <- as.matrix(df)
m.varf_lev_ft <- rbind(m.lev, matrix(NA, nhor, 2))
m.ft_df <- do.call(cbind,lapply(varf_diff$fcst, 
                    function(x) x[,"fcst"]))
 
# growth to level
for(h in (nr_lev+1):(nr_lev+nhor)) {
    hf <- h - nr_lev
    m.varf_lev_ft[h,] <- m.varf_lev_ft[h-1,] + m.ft_df[hf,]
}
 
# Draw Graph
x11(width=8, height = 8); 
par(mfrow=c(4,1), mar=c(2,2,2,2))

str.main <- c(
    "CVX = Chevron Corp.", "XOM = Exxon Mobil")
for(i in 1:2) {
    df <- m.varf_lev_ft[,i]
    matplot(df, type=c("l"), col = c("blue"), 
            main = str.main[i]) 
    abline(v=nr_lev, col="blue")
}
```

## VECM

Cointegration Test
```{r}
df <- data %>% dplyr::select(CVX, XOM)
nr_lev <- nrow(df)
  
  # 1st differenced data
  dif <- as.data.frame(diff(as.matrix(lev), lag = 1))

#========================================================
# Cointegration Test
#========================================================

#———————————————-
# Johansen Cointegration Procedure
#———————————————-
# ecdet  = ‘none’  for no intercept 
#          ‘const’ for constant term
#          ‘trend’ for trend variable 
#          in cointegration
# type   =  eigen or trace test
# K      =  lag order of VAR
# spec   = "transitory" or "longrun"
# season = centered seasonal dummy (4:quarterly)
# dumvar = another dummy variables
#———————————————-
coint_ca.jo <- ca.jo(
    df, ecdet = "const", type  = "eigen", K = 2, 
    spec = "transitory", season = 4, dumvar = NULL)
summary(coint_ca.jo)
```

VECM model estimation
```{r}
#————————————————
# VECM estimation
#————————————————
# VECM(data, lag, r = 1, 
#      include = c("const", "trend", "none", "both"),
#      beta = NULL, estim = c("2OLS", "ML"), 
#      LRinclude = c("none", "const","trend", "both"), 
#      exogen = NULL)
#————————————————
  
VECM_tsDyn <- VECM(df, lag=4, r=1,
                   estim = "2OLS",
                   LRinclude = "const",
                   exogen = NULL)
  
#————————————————
# restricted VECM -> input for r
#————————————————
cajorls_ca.jo <- cajorls(coint_ca.jo, r=1)
  
#————————————————
# the VAR representation of a VECM from ca.jo
#————————————————
# vec2var: Transform a VECM to VAR in levels
# ca.jo is transformed to a VAR in level
# r : The cointegration rank 
#————————————————
vec2var_ca.jo <- vec2var(coint_ca.jo, r=1)
```

Estimation Results
```{r}
#========================================================
# Estimation Results
#========================================================
 
#———————————————-
# parameter estimates from each model
#———————————————-
VECM_tsDyn
cajorls_ca.jo
vec2var_ca.jo
```

Forecast
```{r}
#========================================================
# Forecast
#========================================================
 
  # forecasting horizon
  nhor <- 12 
  
  #———————————————-
  # Forecast from VECM() in tsDyn
  #———————————————-
  
  VECM_pred_tsDyn <- predict(VECM_tsDyn, 
       exoPred = NULL, n.ahead=nhor)
  
  # Draw Graph
  x11(width=8, height = 8); 
  par(mfrow=c(4,1), mar=c(2,2,2,2))
  
  # historical data + forecast data
  df <- rbind(df, VECM_pred_tsDyn)
  
  for(i in 1:2) {
      matplot(df[,i], type=c("l"), col = c("blue"), 
              main = str.main[i]) 
      abline(v=nr_lev, col="blue")
  }
  
  VECM_pred_tsDyn
```

# Time Period

```{r}

```

# Forecasting

```{r}

```

